## Выборка &lt;query&gt;

**Тип метаданных** `query`

**Библиотека компонентов**

```
http://n2oapp.net/framework/config/schema/query-4.0
```
**Атрибуты**

|Наименование|Тип                                |Описание            |Значение по умолчанию|
|------------|-----------------------------------|--------------------|---------------------|
|name        |Строка                             |Наименование выборки|                     |
|object-id   |Ссылка на [объект](#_Объект_object)|Объект выборки      |                     |
|route       |Строка                             |URL выборки         |Идентификатор выборки|

**Пример**

```xml
<?xml version='1.0' encoding='UTF-8'?>
<query xmlns="http://n2oapp.net/framework/config/schema/query-4.0"
  object-id="myObject"
  name="Моя выборка">
  <list>
    <sql>SELECT :select FROM mytable WHERE :filters ORDER BY :sorting LIMIT :limit OFFSET :offset</sql>
  </list>
  <count>
    <sql>SELECT count(*) FROM mytable WHERE :filters</sql>
  </count>
  <fields>
    ...
  </fields>
</query>
```

### &lt;list&gt;

Получение списка записей по определенным фильтрам.

:::note

В выборке может быть несколько *&lt;list&gt;* с разными наборами фильтров (атрибут *filters*).

:::

**Атрибуты**

|Наименование  |Тип                              |Описание                                                                                                      |Значение по умолчанию                                   |
|--------------|---------------------------------|--------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|
|filters       |Идентификаторы через запятую     |Идентификаторы фильтров (`filter-id`). При наличии хотя бы одного из фильтров сработает этот провайдер данных.|                                                        |
|mapper        |dataset, spel, javascript, groovy|Способ маппинга фильтров в параметры провайдера                                                               |dataset                                                 |
|result-mapping|Строка                           |Маппинг списка результатов                                                                                    |Для каждого провайдера данных свои значения по умолчанию|
|count-mapping |Строка                           |Маппинг общего количества записей                                                                             |Для каждого провайдера данных свои значения по умолчанию|

**Тело**

[Провайдер данных](#_Провайдеры_данных)

**Пример**

```xml
<list filters="firstNameLike, lastNameLike">
  <sql>SELECT first_name, last_name
       FROM mytable
       WHERE first_name like '%'||:first_name
          OR last_name '%'||:last_name
  </sql>
</list>
<fields>
  <field id="firstName">
    <filters>
      <like filter-id="firstNameLike" mapping="first_name"/>
    </filters>
  </filed>
  <field id="lastName">
    <filters>
      <like filter-id="lastNameLike" mapping="last_name"/>
    </filters>
  </filed>
</fields>
```

### &lt;count&gt;

Получение количества записей.

:::note

В выборке может быть несколько *&lt;count&gt;* с разными наборами фильтров (атрибут *filters*).

:::

**Атрибуты**


|Наименование |Тип                              |Описание                                                                                                      |Значение по умолчанию                                   |
|-------------|---------------------------------|--------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|
|mapper       |dataset, spel, javascript, groovy|Способ маппинга фильтров в параметры провайдера                                                               |dataset                                                 |
|count-mapping|Строка                           |Маппинг общего количества записей                                                                             |Для каждого провайдера данных свои значения по умолчанию|
|filters      |Идентификаторы через запятую     |Идентификаторы фильтров (`filter-id`). При наличии хотя бы одного из фильтров сработает этот провайдер данных.|                                                        |

**Тело**

[Провайдер данных](#_Провайдеры_данных)

**Пример**

```xml
<count filters="firstNameLike">
  <sql>SELECT count(*) FROM mytable</sql>
</count>
```

### &lt;unique&gt;

Получение уникальной записи по определенным фильтрам.

:::note

В выборке может быть несколько *&lt;unique&gt;* с разными наборами фильтров (атрибут *filters*).

:::

**Атрибуты**

|Наименование  |Тип                              |Описание                                                                                                      |Значение по умолчанию                                   |
|--------------|---------------------------------|--------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|
|filters       |Идентификаторы через запятую     |Идентификаторы фильтров (`filter-id`). При наличии хотя бы одного из фильтров сработает этот провайдер данных.|                                                        |
|mapper        |dataset, spel, javascript, groovy|Способ маппинга фильтров в параметры провайдера                                                               |dataset                                                 |
|result-mapping|Строка                           |Маппинг результата                                                                                            |Для каждого провайдера данных свои значения по умолчанию|

**Тело**

[Провайдер данных](#_Провайдеры_данных)

**Пример**

```xml
<unique filters="id">
  <sql>SELECT first_name, last_name
       FROM mytable
       WHERE id = :id
  </sql>
<unique>
<fields>
  <field id="id">
    <filters>
      <eq/>
    </filters>
  </field>
</fields>
```

### &lt;fields&gt;

Поля выборки.

#### &lt;field&gt;

Поле выборки.

**Атрибуты**

|Наименование|Тип                               |Описание          |Значение по умолчанию                   |
|------------|----------------------------------|------------------|----------------------------------------|
|id          |Строка                            |Идентификатор поля|                                        |
|name        |Строка                            |Наименование поля |Наименование аналогичного поля в объекте|
|domain      |[Тип данных](#_Типы_данных_domain)|Тип данных        |string                                  |

##### &lt;select&gt;

Способ получения данных из поля выборки.

**Атрибуты**

|Наименование |Тип      |Описание                                                          |Значение по умолчанию|
|-------------|---------|------------------------------------------------------------------|---------------------|
|mapping      |Выражение|Маппинг данных поля из провайдера                                 |Совпадает с `id`     |
|default-value|Строка   |Значение, которое проставится в поле, если в провайдере оно пустое|                     |

**Тело**

Определяет как получать это поле выборки в провайдере.
Например, в случае SQL провайдера задаёт значение плейсхолдера `:select`.

**Пример**

```xml
<page>
  <sql>SELECT :select FROM mytable</sql>
</page>
...
<field>
  <select mapping="fname" default-value="Неизвестный">first_name as fname</select>
</field>
```
##### &lt;filters&gt;

Способы фильтрации поля выборки.

**Элементы**

|Наименование       |Тип      |Описание                                |Значение по умолчанию|
|-------------------|---------|----------------------------------------|---------------------|
|&lt;eq&gt;         |Выражение|Фильтр эквивалентности                  |                     |
|&lt;in&gt;         |Выражение|Фильтр вхождения хотя бы одного в список|                     |
|&lt;like&gt;       |Выражение|Фильтр вхождения подстроки в строку     |                     |
|&lt;like-start&gt; |Выражение|Фильтр начала подстроки                 |                     |
|&lt;is-null&gt;    |Выражение|Фильтр пустого поля                     |                     |
|&lt;contains&gt;   |Выражение|Фильтр вхождения списка в список        |                     |
|&lt;overlaps&gt;   |Выражение|Фильтр пересечения списка со списком    |                     |
|&lt;more&gt;       |Выражение|Фильтр больше                           |                     |
|&lt;less&gt;       |Выражение|Фильтр меньше                           |                     |
|&lt;not-eq&gt;     |Выражение|Фильтр не эквивалентности               |                     |
|&lt;not-in&gt;     |Выражение|Фильтр не вхождения в список            |                     |
|&lt;is-not-null&gt;|Выражение|Фильтр не пустого поля                  |                     |

Базовые **Атрибуты**

|Наименование |Тип                               |Описание                                                                                                 |Значение по умолчанию                                                                |
|-------------|----------------------------------|---------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
|filter-id    |Строка                            |Идентификатор фильтра                                                                                    |                                                                                     |
|mapping      |Выражение                         |Маппинг значения фильтра в параметры провайдера                                                          |Эквивалентен `id`                                                                    |
|domain       |[Тип данных](#_Типы_данных_domain)|Тип, в который будет конвертировано значение при отправке в провайдер                                    |Эквивалентен `domain` от `<field>` с преобразованием в список для множественных типов|
|default-value|Строка                            |Значение, по которому будет идти постоянная фильтрация, если для этогофильтра не передано другое значение|                                                                                     |
|normalize    |Строка                            |Выражение для предварительного преобразования входных данных.                                            |                                                                                     |

**Пример**

```xml
<filters>
  <eq mapping="gender_id"
    default-value="1">gender_id = :gender_id</eq>
  <in filter-id="genders*.id"
    mapping="genders"
    domain="integer[]">gender_id in (:genders)</in>
  <like filter-id="gender.name" domain="string" normalize="#this.toLowerCase()"/>
</filters>
```

##### &lt;sorting&gt;

Способ сортировки поля выборки.

**Атрибуты**

|Наименование|Тип      |Описание                                                |Значение по умолчанию|
|------------|---------|--------------------------------------------------------|---------------------|
|mapping     |Выражение|Маппинг плейсхолдера направления сортировки в провайдере|`[fieldId]Direction` |

**Тело**

Определяет как сортировать это поле выборки в провайдере.
Например, в случае SQL провайдера задаёт значение плейсхолдера `:sorting`.

**Пример**

```xml
<page>
  <sql>SELECT first_name FROM mytable ORDER BY :sorting</sql>
</page>
...
<field id="firstName">
  <sorting mapping="firstNameDirection">first_name :firstNameDirection</sorting>
</field>
```

##### &lt;expression&gt;

Задаёт значение плейсхолдера `:expression`, который можно использовать в теле `<select>`, `<filters>`, `<sorting>`.

**Тело**

Значение плейсхолдера `:expression`.

##### &lt;join&gt;

Задаёт выражение для соединения с другими сущностями(таблицами), если это необходимо для этого поля.

**Тело**

Определяет с какими сущностями(таблицами) необходимо соединиться, чтобы получить поле.
Например, в случае SQL провайдера задаёт значение плейсхолдера `:join`.

**Пример**

```xml
<field id="firstName">
  <expression>t1.first_name</expression>
  <select mapping="fname">:expression as fname</select>
  <filters>
    <eq mapping="first_name">:expression = :first_name</eq>
  </filters>
  <sorting>:expression :direction</sorting>
  <join>table t1 on t1.id=t2.t1_id</join>
</field>
```
